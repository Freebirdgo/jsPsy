<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>数字刺激課題</title>
    <script
      src="https://unpkg.com/jspsych@7.3.4"
      type="text/javascript"
    ></script>
    <script
      src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"
      type="text/javascript"
    ></script>
    <script
      src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"
      type="text/javascript"
    ></script>
    <script
      src="https://unpkg.com/@jspsych/plugin-call-function@1.1.3"
      type="text/javascript"
    ></script>
    <script
      src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"
      type="text/javascript"
    ></script>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 50px;
      }
      .centered {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    </style>
  </head>
  <body>
    <script>
      // Initialize jsPsych - Note: The on_finish here will be overwritten later
      const jsPsych = initJsPsych();

      // --- GitHub Upload Configuration ---
      // !!! SECURITY WARNING !!!
      // Hardcoding your PAT token here is VERY DANGEROUS.
      // Anyone viewing the page source can steal it.
      // Consider using a server-side script or a dedicated service (like JATOS, Pavlovia, or your own backend)
      // to handle data saving securely. For testing purposes only.
      const GITHUB_TOKEN = "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"; // <-- PASTE YOUR PAT HERE (USE WITH EXTREME CAUTION)
      const REPO_OWNER = "Freebirdgo";
      const REPO_NAME = "jsPsy";
      // !!! DATA OVERWRITING WARNING !!!
      // This file path will be OVERWRITTEN by each participant.
      // Consider making the filename unique per participant (e.g., using subject ID and timestamp).
      const FILE_PATH = "data/jspsych_results.csv"; // Path within your repository

      // --- GitHub Upload Function ---
      function uploadToGitHub(csvData, subjectId) {
        // Option 1: Overwrite the file every time (simple, but loses previous data)
        const filePath = FILE_PATH;

        // Option 2: Create a unique filename (better for multiple participants)
        // const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        // const uniqueFileName = `jspsych_results_${subjectId}_${timestamp}.csv`;
        // const filePath = `data/${uniqueFileName}`; // Assumes a 'data' folder exists

        const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`;

        // Base64 encode the CSV data
        // Use btoa(unescape(encodeURIComponent(csvData))) for proper handling of UTF-8 characters if needed
        const encodedContent = btoa(csvData);

        // Prepare the payload for the GitHub API
        const payload = {
          message: `Add jsPsych result for subject ${subjectId || "unknown"}`, // Add subject ID to commit message
          content: encodedContent,
          // To update an existing file instead of always overwriting, you'd first need to
          // GET the file to retrieve its 'sha', then include it in the payload:
          // sha: fileSha // (obtained from a previous GET request)
        };

        fetch(url, {
          method: "PUT", // Creates or overwrites the file
          headers: {
            Authorization: `token ${GITHUB_TOKEN}`,
            "Content-Type": "application/json",
            Accept: "application/vnd.github.v3+json", // Recommended Accept header
          },
          body: JSON.stringify(payload),
        })
          .then((response) => {
            if (!response.ok) {
              // If response is not OK, throw an error to be caught by .catch
              return response.json().then((err) => {
                throw new Error(
                  `GitHub API Error: ${response.status} ${
                    response.statusText
                  } - ${err.message || JSON.stringify(err)}`
                );
              });
            }
            return response.json();
          })
          .then((data) => {
            console.log("✅ GitHub Upload Successful:", data);
            // Optionally inform the user, but avoid popups if possible for better UX
            // alert("Results uploaded to GitHub!");
            // Instead, you might update the content of the final page.
            document.body.innerHTML = `<div class="centered" style="font-size: 24px;">実験は終了しました。ご協力ありがとうございました。<br>データは正常に保存されました。</div>`;
          })
          .catch((error) => {
            console.error("❌ GitHub Upload Failed:", error);
            // Inform the user about the failure
            // alert("Error uploading results. Please contact the researcher.");
            document.body.innerHTML = `<div class="centered" style="font-size: 24px; color: red;">エラーが発生しました。<br>結果をGitHubにアップロードできませんでした。<br>研究者に連絡してください。<br><br><pre>${error.message}</pre></div>`;
            // As a fallback, you could trigger the download here
            // downloadCSV(csvData, `fallback_results_${subjectId}.csv`);
          });
      }

      // --- Helper function for fallback download (optional) ---
      function downloadCSV(csvData, filename) {
        const blob = new Blob([csvData], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        if (link.download !== undefined) {
          // Feature detection
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", filename);
          link.style.visibility = "hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      // --- Overwrite on_finish to use GitHub Upload ---
      jsPsych.on_finish = () => {
        const results = jsPsych.data.get();
        const csv = results.csv();
        const subjectId =
          results.select("subject").values[0] || "unknown_subject"; // Get subject ID from data
        console.log(
          "Experiment finished. Preparing to upload data for subject:",
          subjectId
        );
        uploadToGitHub(csv, subjectId); // Call the upload function
      };

      // --- Experiment Definition ---

      const subject_id = {
        type: jsPsychSurveyText,
        questions: [
          {
            prompt: "被験者の名前またはIDを入力してください：", // Changed prompt slightly
            name: "subject",
            required: true,
          },
        ],
        on_finish: (data) => {
          // This way of adding properties is safer
          if (data.response && data.response.subject) {
            jsPsych.data.addProperties({ subject: data.response.subject });
          } else if (data.responses) {
            // Fallback for older jsPsych or different response structure
            try {
              const responses = JSON.parse(data.responses);
              jsPsych.data.addProperties({ subject: responses.subject });
            } catch (e) {
              console.error(
                "Could not parse subject ID response:",
                data.responses
              );
              jsPsych.data.addProperties({ subject: "parsing_error" });
            }
          } else {
            jsPsych.data.addProperties({ subject: "not_provided" });
          }
        },
      };

      // Timestamping
      let timestamps = {};
      function log_event(label) {
        timestamps[label] = Math.round(performance.now());
      }

      // Trial Creation Function (Unchanged from your code)
      function createTrial(trial) {
        const timeline = [];
        timestamps = {}; // Reset for each trial

        timeline.push({
          type: jsPsychCallFunction,
          func: () => log_event("trial_start"),
        });

        timeline.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '<div class="centered" style="font-size:48px;">+</div>',
          choices: "NO_KEYS",
          trial_duration: 1000,
        });

        trial.numbers.forEach((num, index) => {
          timeline.push({
            type: jsPsychCallFunction,
            func: () => log_event(`number_${index + 1}`),
          });
          timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<div class="centered" style="font-size:48px;">${num}</div>`,
            choices: "NO_KEYS",
            trial_duration: 1000,
          });
        });

        const target_symbol = trial.target === "maru" ? "◯" : "☆";
        const position_style =
          trial.position === "left"
            ? "position:absolute; top:50%; left:20%; transform:translateY(-50%);"
            : "position:absolute; top:50%; right:20%; transform:translateY(-50%);";
        const target_html = `<div style="font-size:60px; ${position_style}">${target_symbol}</div>`;

        timeline.push({
          type: jsPsychCallFunction,
          func: () => log_event("target_onset"),
        });

        timeline.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: target_html,
          trial_duration: 2000,
          response_ends_trial: true,
          choices: [" "], // Spacebar only
          on_finish: (data) => {
            const responded = data.response !== null;
            const correct =
              (trial.target === "maru" && responded) ||
              (trial.target === "hoshi" && !responded);

            // Add trial-specific data
            data.numbers = trial.numbers.join("-");
            data.position = trial.position;
            data.target = trial.target;
            data.correct = correct;
            data.responded = responded;

            // Add timestamp data
            for (const key in timestamps) {
              data[key + "_time"] = timestamps[key];
            }
            // Calculate response time relative to trial_start (or target_onset if preferred)
            if (data.rt !== null && timestamps["target_onset"] !== undefined) {
              // data.response_time_from_target = Math.round(data.rt); // jsPsych rt is relative to stimulus onset
              data.response_timestamp = Math.round(
                timestamps["target_onset"] + data.rt
              ); // Absolute timestamp of response
            } else {
              // data.response_time_from_target = null;
              data.response_timestamp = null;
            }
            // Clean up rt from jsPsych default data if needed, as we added custom timing
            // delete data.rt;
          },
        });

        return timeline;
      }

      // Practice Trials (Unchanged)
      const practice_trials = [
        { numbers: ["7", "5", "3"], position: "left", target: "hoshi" },
        // { numbers: ["7", "5", "3"], position: "right", target: "maru" },
        // { numbers: ["3", "5", "7"], position: "left", target: "maru" },
        // { numbers: ["3", "5", "7"], position: "right", target: "hoshi" },
      ];
      const practice_timeline = practice_trials.flatMap(createTrial);

      // Main Trials (Unchanged logic, just using the functions)
      function isIncreasing(array) {
        return array.every((val, i, arr) => i === 0 || arr[i - 1] < val);
      }
      function isDecreasing(array) {
        return array.every((val, i, arr) => i === 0 || arr[i - 1] > val);
      }
      const candidate_trials = [
        // Left ◯, Right ☆ (Increasing)
        { numbers: ["5", "13", "21"], position: "left", target: "hoshi" },
        { numbers: ["5", "13", "21"], position: "right", target: "hoshi" },
        // { numbers: ["5", "13", "21"], position: "left", target: "maru" },
        // { numbers: ["5", "13", "21"], position: "right", target: "maru" },
        // { numbers: ["5", "14", "23"], position: "left", target: "hoshi" },
        // { numbers: ["5", "14", "23"], position: "right", target: "hoshi" },
        // { numbers: ["5", "14", "23"], position: "left", target: "maru" },
        // { numbers: ["5", "14", "23"], position: "right", target: "maru" },
        // { numbers: ["5", "15", "25"], position: "left", target: "hoshi" },
        // { numbers: ["5", "15", "25"], position: "right", target: "hoshi" },
        // { numbers: ["5", "15", "25"], position: "left", target: "maru" },
        // { numbers: ["5", "15", "25"], position: "right", target: "maru" },
        // { numbers: ["5", "16", "27"], position: "left", target: "hoshi" },
        // { numbers: ["5", "16", "27"], position: "right", target: "hoshi" },
        // { numbers: ["5", "16", "27"], position: "right", target: "maru" },
        // { numbers: ["5", "16", "27"], position: "left", target: "maru" },
        // { numbers: ["5", "17", "29"], position: "left", target: "hoshi" },
        // { numbers: ["5", "17", "29"], position: "right", target: "hoshi" },
        // { numbers: ["5", "17", "29"], position: "right", target: "maru" },
        // { numbers: ["5", "17", "29"], position: "left", target: "maru" }, // Left ☆, Right ◯ (Decreasing)
        // { numbers: ["25", "13", "1"], position: "left", target: "hoshi" },
        // { numbers: ["25", "13", "1"], position: "right", target: "hoshi" },
        // { numbers: ["25", "13", "1"], position: "left", target: "maru" },
        // { numbers: ["25", "13", "1"], position: "right", target: "maru" },
        // { numbers: ["25", "14", "3"], position: "left", target: "hoshi" },
        // { numbers: ["25", "14", "3"], position: "right", target: "hoshi" },
        // { numbers: ["25", "14", "3"], position: "left", target: "maru" },
        // { numbers: ["25", "14", "3"], position: "right", target: "maru" },
        // { numbers: ["25", "15", "5"], position: "left", target: "hoshi" },
        // { numbers: ["25", "15", "5"], position: "right", target: "hoshi" },
        // { numbers: ["25", "15", "5"], position: "left", target: "maru" },
        // { numbers: ["25", "15", "5"], position: "right", target: "maru" },
        // { numbers: ["25", "16", "7"], position: "left", target: "hoshi" },
        // { numbers: ["25", "16", "7"], position: "right", target: "hoshi" },
        // { numbers: ["25", "16", "7"], position: "right", target: "maru" },
        // { numbers: ["25", "16", "7"], position: "left", target: "maru" },
        // { numbers: ["25", "17", "9"], position: "left", target: "hoshi" },
        // { numbers: ["25", "17", "9"], position: "right", target: "hoshi" },
        // { numbers: ["25", "17", "9"], position: "right", target: "maru" },
        // { numbers: ["25", "17", "9"], position: "left", target: "maru" },
      ];
      const increasing_trials = candidate_trials.filter((t) =>
        isIncreasing(t.numbers.map(Number))
      );
      const decreasing_trials = candidate_trials.filter((t) =>
        isDecreasing(t.numbers.map(Number))
      );
      const main_trials = jsPsych.randomization.shuffle(
        increasing_trials.concat(decreasing_trials)
      );
      const main_timeline_nodes = main_trials.flatMap(createTrial); // Renamed to avoid conflict

      // --- Experiment Timeline ---
      jsPsych.run([
        subject_id, // Ask for subject ID first
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
      <div class="centered" style="font-size: 24px;">
        練習パートを始めます。<br><br>
        <strong>◯ のときはスペースキーを押し、☆ のときは押さないでください。</strong><br><br>
        準備ができたらスペースキーを押してスタートしてください。
      </div>
    `,
          choices: [" "],
        },
        ...practice_timeline, // Run practice trials
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
      <div class="centered" style="font-size: 24px;">
        練習は終わりです。<br><br>
        本実験を始めます。<br><br>
        <strong>◯ のときはスペースキーを押し、☆ のときは押さないでください。</strong><br><br>
        準備ができたらスペースキーを押してスタートしてください。
      </div>
    `,
          choices: [" "],
        },
        ...main_timeline_nodes, // *** Run MAIN trials HERE ***
        {
          type: jsPsychHtmlKeyboardResponse, // Use keyboard response or button response
          stimulus: `
      <div class="centered" style="font-size: 24px;">
        実験は終了しました。<br><br>
        結果を保存しています...しばらくお待ちください。<br><br>
        （このメッセージが長時間表示されたままの場合は、研究者に連絡してください）
      </div>
    `,
          choices: "NO_KEYS", // Don't allow dismissal until upload finishes/fails
          trial_duration: null, // Wait indefinitely (upload function will change the body content)
        },
        // The jsPsych.on_finish function handles the upload AFTER this timeline completes
      ]);
    </script>
  </body>
</html>
